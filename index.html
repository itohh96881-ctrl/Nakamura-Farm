<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Command V21 - Hybrid Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- USER CONFIGURATION ---------------------------------------------
        const myFirebaseConfig = {
            apiKey: "AIzaSyCbwtb6PCIKITCNJLftprKeSxfvCdAr-ic",
            authDomain: "nakamura-farm-f06b9.firebaseapp.com",
            projectId: "nakamura-farm-f06b9",
            storageBucket: "nakamura-farm-f06b9.firebasestorage.app",
            messagingSenderId: "707695385840",
            appId: "1:707695385840:web:bb09fb2e37ab5cd4ee7635"
        };
        // ---------------------------------------------------------------------

        let firebaseConfig;
        let appId = 'nakamura-farm-budget';

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } else {
            firebaseConfig = myFirebaseConfig;
        }

        let db, auth, user;

        window.addEventListener('DOMContentLoaded', () => {
            const pidDisplay = document.getElementById('projectIdDisplay');
            if (pidDisplay && firebaseConfig) pidDisplay.innerText = `ID: ${firebaseConfig.projectId}`;
        });

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Failed:", error);
                    showToast("Auth Failed: Using Local Mode", "bg-red-600");
                });

                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        initDataSync();
                    }
                });
            } catch (e) {
                console.error("Init Failed:", e);
                showToast("Config Error: Using Local Mode", "bg-red-600");
            }
        }

        function updateNetworkStatus(msg, colorClass) {
            const el = document.getElementById('networkStatus');
            if (el) {
                el.innerText = msg;
                el.className = `text-[10px] font-bold font-sci-fi tracking-widest ${colorClass}`;
            }
        }

        // --- Data Sync Logic ---
        const COLLECTION_NAME = "budget_entries";
        const DATA_DOC_ID = "budget_data_v1";
        const LOCAL_KEY = "nakamura_budget_v1";

        function initDataSync() {
            if (!user || !db) return;

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, DATA_DOC_ID);

            onSnapshot(docRef, (snapshot) => {
                updateNetworkStatus("ONLINE (SYNC ACTIVE)", "text-emerald-400");

                if (snapshot.exists()) {
                    const data = snapshot.data();
                    if (data.appState) {
                        window.appState = JSON.parse(data.appState);

                        // Fix Sector Names
                        window.appState.L1.name = "è¾²åœ’äº‹æ¥­ (Farm)";
                        window.appState.L1.icon = "ğŸŒ±";
                        window.appState.L1.colorClass = "green";
                        window.appState.L2.name = "è²©å£²äº‹æ¥­ (Sales)";
                        window.appState.L2.icon = "ğŸ›’";
                        window.appState.L2.colorClass = "blue";
                        window.appState.L3.name = "ã‚«ãƒ•ã‚§ãƒãƒ¼ (Cafe)";
                        window.appState.L3.icon = "â˜•";
                        window.appState.L3.colorClass = "orange";

                        if (!window.appState.fixedMonths) window.appState.fixedMonths = {};
                        // Fix 0 value bug: Check strict undefined
                        if (window.appState.initialCash === undefined) window.appState.initialCash = 1000000;

                        window.dispatchEvent(new Event('state-updated'));
                    }
                } else {
                    saveToCloud();
                }
            }, (error) => {
                console.error("Snapshot Error:", error);
                if (error.code === 'permission-denied') {
                    updateNetworkStatus("PERMISSION WARNING", "text-orange-400");
                } else {
                    updateNetworkStatus("CONNECTION RETRYING", "text-yellow-400");
                }
            });
        }

        window.saveToCloud = async function () {
            localStorage.setItem(LOCAL_KEY, JSON.stringify(window.appState));

            if (!user || !db) {
                showToast("Saved Locally (Offline)", "bg-slate-600");
                return;
            }

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, DATA_DOC_ID);
            try {
                await setDoc(docRef, {
                    appState: JSON.stringify(window.appState),
                    lastUpdated: new Date().toISOString(),
                    updatedBy: user.uid
                }, { merge: true });

                showToast("â˜ï¸ Saved", "bg-emerald-600");
                updateNetworkStatus("ONLINE (SAVED)", "text-emerald-400");
            } catch (e) {
                console.error("Save Error:", e);
                showToast("Save Failed (Local Only)", "bg-red-500");
            }
        };

        function showToast(msg, bgClass) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            if (toast && toastMsg) {
                toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg text-white text-xs font-bold transition-opacity duration-500 ${bgClass}`;
                toastMsg.innerText = msg;
                toast.style.opacity = '1';
                setTimeout(() => { toast.style.opacity = '0'; }, 3000);
            }
        }
        window.showToast = showToast;

    </script>

    <link
        href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }

        .font-sci-fi {
            font-family: 'Chakra Petch', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .scan-effect::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(16, 185, 129, 0.03) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
        }

        .tab-active {
            border-bottom: 2px solid #10b981;
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #64748b;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
            border-color: #38bdf8;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        [contenteditable="true"]:focus {
            outline: none;
            border-bottom: 1px dashed #10b981;
            background-color: rgba(16, 185, 129, 0.1);
            color: #fff;
        }

        [contenteditable="true"]:hover {
            cursor: text;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: #64748b;
        }

        .modal-tab-active {
            background-color: #1e293b;
            color: #34d399;
            border-bottom: 2px solid #34d399;
        }

        .modal-tab-inactive {
            background-color: transparent;
            color: #94a3b8;
            border-bottom: 2px solid transparent;
        }

        .badge-win {
            background-color: #059669;
            color: white;
            border: 1px solid #34d399;
            box-shadow: 0 0 10px #059669;
        }

        .badge-lose {
            background-color: #dc2626;
            color: white;
            border: 1px solid #f87171;
            box-shadow: 0 0 10px #dc2626;
        }
    </style>
</head>

<body class="h-screen flex flex-col scan-effect relative">

    <!-- HUD Header -->
    <header
        class="h-16 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-6 z-20 shadow-lg shrink-0">
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-3">
                <div
                    class="w-10 h-10 bg-emerald-600 rounded flex items-center justify-center font-sci-fi font-bold text-xl shadow-[0_0_10px_rgba(16,185,129,0.5)]">
                    N</div>
                <div>
                    <div class="flex items-center group editable-trigger">
                        <h1 contenteditable="true"
                            class="font-sci-fi font-bold text-lg tracking-wider text-emerald-100 leading-tight">
                            STRATEGIC COMMAND V20</h1>
                        <span class="ml-2 text-xs text-slate-600">CLOUD SYNC</span>
                    </div>
                    <div class="flex items-center group editable-trigger">
                        <p id="projectIdDisplay" class="text-[10px] text-slate-500 font-mono">Connecting...</p>
                    </div>
                </div>
            </div>

            <div class="flex space-x-1 bg-slate-800 rounded p-1">
                <button onclick="switchView('monthly')" id="tab-monthly"
                    class="tab-active px-4 py-1.5 text-sm font-bold rounded transition flex items-center">
                    <span class="mr-2">ğŸ“…</span> æœˆæ¬¡å…¥åŠ›
                </button>
                <button onclick="switchView('annual')" id="tab-annual"
                    class="tab-inactive px-4 py-1.5 text-sm font-bold rounded transition flex items-center">
                    <span class="mr-2">ğŸ“ˆ</span> å¹´é–“æ¨ç§»
                </button>
            </div>
        </div>

        <div class="flex space-x-8 items-center">
            <!-- API Key Button -->
            <button onclick="openApiKeyModal()"
                class="text-xs text-slate-500 hover:text-emerald-400 transition font-mono border border-slate-700 px-2 py-1 rounded">
                ğŸ”‘ API KEY
            </button>

            <div id="monthSelectorContainer"
                class="flex items-center bg-slate-800 rounded px-2 py-1 border border-slate-700">
                <button onclick="changeMonth(-1)" class="text-slate-400 hover:text-white px-2 py-1">â—€</button>
                <div class="text-center px-2">
                    <div class="text-[10px] text-slate-500 uppercase tracking-wider">TARGET</div>
                    <div class="font-sci-fi font-bold text-xl text-emerald-400" id="currentMonthDisplay">2025-10</div>
                </div>
                <button onclick="changeMonth(1)" class="text-slate-400 hover:text-white px-2 py-1">â–¶</button>
            </div>

            <div class="text-right">
                <div id="networkStatus" class="text-[10px] font-bold font-sci-fi tracking-widest text-slate-500">
                    INITIALIZING...</div>
                <div class="font-sci-fi font-bold text-2xl text-yellow-400" id="globalProfit">Â¥0</div>
            </div>
        </div>
    </header>

    <!-- Content Area -->
    <div class="flex-1 overflow-hidden relative">

        <!-- VIEW 1: MONTHLY COMMAND -->
        <div id="view-monthly"
            class="absolute inset-0 flex flex-col transition-transform duration-300 transform translate-x-0">
            <div class="flex-1 flex overflow-hidden">
                <!-- Sidebar -->
                <nav
                    class="w-24 bg-slate-800 border-r border-slate-700 flex flex-col items-center py-6 space-y-4 z-10 shrink-0">
                    <button onclick="switchLevel('L1')" id="nav-L1"
                        class="group w-16 h-16 rounded-xl bg-slate-700 text-slate-400 flex flex-col items-center justify-center transition border-2 border-transparent">
                        <span class="text-2xl mb-1">ğŸŒ±</span><span class="text-[10px] font-bold font-sci-fi">è¾²åœ’</span>
                    </button>
                    <button onclick="switchLevel('L2')" id="nav-L2"
                        class="group w-16 h-16 rounded-xl bg-slate-700 text-slate-400 flex flex-col items-center justify-center transition border-2 border-transparent">
                        <span class="text-2xl mb-1">ğŸ›’</span><span class="text-[10px] font-bold font-sci-fi">è²©å£²</span>
                    </button>
                    <button onclick="switchLevel('L3')" id="nav-L3"
                        class="group w-16 h-16 rounded-xl bg-slate-700 text-slate-400 flex flex-col items-center justify-center transition border-2 border-transparent">
                        <span class="text-2xl mb-1">â˜•</span><span class="text-[10px] font-bold font-sci-fi">ã‚«ãƒ•ã‚§ãƒãƒ¼</span>
                    </button>
                </nav>

                <!-- Workspace -->
                <main class="flex-1 bg-slate-900 relative overflow-y-auto p-6">
                    <!-- Fix / Unfix Header Bar -->
                    <div
                        class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-md">
                        <div class="flex items-center space-x-4">
                            <span class="text-slate-400 text-sm font-bold">STATUS:</span>
                            <span id="fixStatusBadge"
                                class="px-3 py-1 rounded text-xs font-black tracking-widest bg-slate-700 text-slate-400">EDITING</span>
                        </div>
                        <button onclick="toggleFixMonth()" id="btnToggleFix"
                            class="px-6 py-2 rounded bg-blue-600 hover:bg-blue-500 text-white font-bold font-sci-fi transition shadow-lg">
                            ğŸ”’ FIX MONTH
                        </button>
                    </div>

                    <!-- Result Board -->
                    <div id="resultBoard" class="hidden mb-8 animate-pop">
                        <div class="grid grid-cols-3 gap-6">
                            <!-- Revenue Result -->
                            <div class="bg-slate-800 p-6 rounded-xl border-2 border-slate-700 relative overflow-hidden">
                                <div class="text-xs text-slate-400 font-bold mb-2 tracking-widest">TOTAL REVENUE (å£²ä¸Š)
                                </div>
                                <div class="flex justify-between items-end mb-2">
                                    <span class="text-3xl font-mono font-bold text-white" id="resRevAct">Â¥0</span>
                                    <span class="text-sm text-slate-500 mb-1">Plan: <span
                                            id="resRevPlan">Â¥0</span></span>
                                </div>
                                <div id="badgeRev"
                                    class="absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-lose">
                                    LOSE</div>
                                <div class="w-full bg-slate-900 h-2 rounded-full overflow-hidden">
                                    <div id="barRev" class="bg-emerald-500 h-full w-0"></div>
                                </div>
                            </div>

                            <!-- Expense Result -->
                            <div class="bg-slate-800 p-6 rounded-xl border-2 border-slate-700 relative overflow-hidden">
                                <div class="text-xs text-slate-400 font-bold mb-2 tracking-widest">TOTAL EXPENSE (æ”¯å‡º)
                                </div>
                                <div class="flex justify-between items-end mb-2">
                                    <span class="text-3xl font-mono font-bold text-white" id="resExpAct">Â¥0</span>
                                    <span class="text-sm text-slate-500 mb-1">Plan: <span
                                            id="resExpPlan">Â¥0</span></span>
                                </div>
                                <div id="badgeExp"
                                    class="absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-win">
                                    WIN</div>
                                <div class="w-full bg-slate-900 h-2 rounded-full overflow-hidden">
                                    <div id="barExp" class="bg-red-500 h-full w-0"></div>
                                </div>
                            </div>

                            <!-- Profit Result -->
                            <div class="bg-slate-800 p-6 rounded-xl border-2 border-slate-700 relative overflow-hidden">
                                <div class="text-xs text-slate-400 font-bold mb-2 tracking-widest">OPERATING PROFIT (åˆ©ç›Š)
                                </div>
                                <div class="flex justify-between items-end mb-2">
                                    <span class="text-3xl font-mono font-bold text-white" id="resProfit">Â¥0</span>
                                    <span class="text-sm text-slate-500 mb-1">Plan: <span
                                            id="resProfitPlan">Â¥0</span></span>
                                </div>
                                <div id="badgeProfit"
                                    class="absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-lose">
                                    LOSE</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis Section -->
                    <div id="aiAnalysisSection"
                        class="hidden mb-8 animate-fade-in bg-slate-800/50 border border-emerald-500/30 p-4 rounded-xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                        <h3 class="text-emerald-400 font-bold font-sci-fi tracking-widest flex items-center mb-2">
                            <span class="mr-2 text-xl">ğŸ¤–</span> STRATEGIC AI DIAGNOSIS
                        </h3>
                        <div id="aiLoading" class="hidden text-xs font-mono text-emerald-500/80 animate-pulse mb-2">
                            ANALYZING BATTLEFIELD DATA... [//////// ]
                        </div>
                        <div id="aiComment"
                            class="text-sm text-slate-300 font-sans leading-relaxed tracking-wide typing-effect min-h-[40px]">
                        </div>
                        <button id="btnAiRefresh" onclick="forceReAnalyze()"
                            class="absolute top-4 right-4 text-xs bg-emerald-900/50 hover:bg-emerald-800 text-emerald-400 border border-emerald-700 px-2 py-1 rounded hidden transition">
                            ğŸ”„ RE-ANALYZE (With Reviews)
                        </button>
                    </div>

                    <!-- Sector Header -->
                    <div
                        class="flex justify-between items-end mb-6 border-b border-slate-700 pb-2 sticky top-0 bg-slate-900/95 backdrop-blur z-10 pt-2">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center">
                                <span id="sectorIcon" class="mr-3 text-3xl">ğŸŒ±</span>
                                <div>
                                    <span id="sectorTitle"
                                        class="font-sci-fi block text-emerald-400 text-xs tracking-widest">SECTOR
                                        L1</span>
                                    <span id="sectorName" contenteditable="true" onblur="updateSectorName(this)"
                                        class="text-xl outline-none border-b border-transparent focus:border-emerald-500 transition">è¾²åœ’äº‹æ¥­
                                        (Farm)</span>
                                </div>
                            </h2>
                        </div>
                        <div
                            class="flex space-x-4 text-sm font-mono bg-slate-800 p-2 rounded-lg border border-slate-600">
                            <div class="flex items-center text-green-400"><span
                                    class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Plan Rev: <span
                                    id="sectorRevPlan" class="ml-2 font-bold">Â¥0</span></div>
                            <div class="flex items-center text-red-400"><span
                                    class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>Plan Exp: <span
                                    id="sectorExpPlan" class="ml-2 font-bold">Â¥0</span></div>
                        </div>
                    </div>

                    <!-- Input Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 relative">
                        <div id="lockedOverlay"
                            class="hidden absolute inset-0 bg-slate-900/50 backdrop-blur-[2px] z-20 flex flex-col items-center justify-center border-2 border-slate-700 rounded-xl">
                            <div class="text-4xl mb-4">ğŸ”’</div>
                            <h3 class="text-2xl font-bold text-white font-sci-fi">MONTH FIXED</h3>
                            <p class="text-slate-400 mb-6">ç¢ºå®šæ¸ˆã¿ã§ã™ã€‚ç·¨é›†ã™ã‚‹ã«ã¯ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„ã€‚</p>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-4 border-l-4 border-green-500 pl-3">
                                <h3 class="text-green-400 font-bold font-sci-fi tracking-widest">REVENUE (åå…¥)</h3>
                                <span class="text-xs text-slate-500 font-mono">Month: <span
                                        class="current-month-text">--</span></span>
                            </div>
                            <div id="revenueContainer" class="space-y-3"></div>
                            <button id="btnNewRev" onclick="openCategoryModal('revenue')"
                                class="w-full py-3 mt-4 border-2 border-dashed border-slate-700 text-slate-500 rounded-xl hover:bg-slate-800 hover:text-green-400 transition font-bold">+
                                ç§‘ç›®è¿½åŠ  (åå…¥)</button>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4 border-l-4 border-red-500 pl-3">
                                <h3 class="text-red-400 font-bold font-sci-fi tracking-widest">EXPENSES (æ”¯å‡º)</h3>
                                <span class="text-xs text-slate-500 font-mono">Month: <span
                                        class="current-month-text">--</span></span>
                            </div>
                            <div id="expenseContainer" class="space-y-3"></div>
                            <button id="btnNewExp" onclick="openCategoryModal('expense')"
                                class="w-full py-3 mt-4 border-2 border-dashed border-slate-700 text-slate-500 rounded-xl hover:bg-slate-800 hover:text-red-400 transition font-bold">+
                                ç§‘ç›®è¿½åŠ  (æ”¯å‡º)</button>
                        </div>
                    </div>
                    <div class="h-20"></div>
                </main>
            </div>
        </div>

        <!-- VIEW 2: ANNUAL STRATEGY -->
        <div id="view-annual"
            class="absolute inset-0 bg-slate-100 flex flex-col transition-transform duration-300 transform translate-x-full overflow-y-auto">
            <div class="max-w-7xl mx-auto w-full p-8 space-y-8">
                <div class="flex justify-between items-end border-b border-slate-300 pb-4">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 flex items-center gap-3"><span
                                class="bg-blue-600 text-white rounded p-1 text-2xl">ğŸ“Š</span> å¹´é–“åæ”¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                        <p class="text-slate-500 mt-1">Fiscal Year Outlook (Oct 2025 - Sep 2026)</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="bg-white p-3 rounded shadow-sm border border-slate-200">
                            <div class="text-xs text-slate-400 uppercase">æœŸé¦–æ®‹é«˜ (è¨­å®šå¯)</div>
                            <input type="number" id="initialCashInput"
                                class="text-xl font-bold text-slate-800 w-32 border-b border-slate-300 focus:border-blue-500 outline-none"
                                placeholder="0" onchange="updateInitialCash(this.value)">
                        </div>
                    </div>
                </div>

                <!-- CASH FLOW CHART -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-slate-200 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-yellow-400"></div>
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ’°</span>
                        è³‡é‡‘ç¹°ã‚Šäºˆæ¸¬ (Cash Flow: å®Ÿç¸¾+äºˆå®š ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰)
                    </h3>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                    <div class="mt-2 text-xs text-slate-500 text-right">*ç¢ºå®š(Fix)æœˆã¯å®Ÿç¸¾ã€æœªç¢ºå®šæœˆã¯äºˆç®—ãƒ™ãƒ¼ã‚¹ã§è¨ˆç®—ã•ã‚Œã¾ã™</div>
                </div>

                <!-- Other Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4">ğŸ“ˆ äºˆå®Ÿæ¨ç§» (Profit/Loss Trend)</h3>
                        <div class="chart-container"><canvas id="annualTrendChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4">ğŸ° éƒ¨é–€åˆ¥å£²ä¸Šæ§‹æˆ (Actual)</h3>
                        <div class="chart-container"><canvas id="annualSectorChart"></canvas></div>
                    </div>
                </div>

                <div class="h-10"></div>
            </div>
        </div>
    </div>

    <!-- Modals (Detail / Category / Toast) ... (Same as previous) -->
    <!-- Modal 1: Detail -->
    <div id="detailModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-slate-800 w-full max-w-3xl rounded-xl shadow-2xl border border-slate-600 flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-slate-700 bg-slate-900 rounded-t-xl flex justify-between">
                <div>
                    <div class="text-xs text-emerald-400 font-sci-fi mb-1">EDITING DETAILS</div>
                    <h3 class="text-2xl font-bold text-white" id="modalTitle">Account</h3>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-400 uppercase">Total (<span id="modalMonthDisp"></span>)</div>
                    <div class="text-3xl font-mono font-bold text-white" id="modalTotal">Â¥0</div>
                </div>
            </div>
            <div class="flex border-b border-slate-700 bg-slate-900 px-2">
                <button onclick="switchModalTab('actual')" id="modalTabActual"
                    class="flex-1 py-3 text-sm font-bold transition modal-tab-active">ğŸ“Š Actual (å®Ÿç¸¾)</button>
                <button onclick="switchModalTab('budget')" id="modalTabBudget"
                    class="flex-1 py-3 text-sm font-bold transition modal-tab-inactive">ğŸ¯ Budget (äºˆç®—)</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900/30" id="modalItemsList"></div>

            <!-- Category Review Section (Visible only in Fix Mode) -->
            <div id="modalReviewSection" class="hidden px-5 py-3 bg-slate-800/80 border-t border-slate-700">
                <label class="text-xs text-emerald-400 font-bold mb-1 block">ğŸ’¬ CATEGORY REVIEW (ç§‘ç›®æŒ¯ã‚Šè¿”ã‚Š)</label>
                <textarea id="modalCategoryReview" rows="2"
                    class="w-full bg-slate-900 text-slate-300 text-sm p-2 rounded border border-slate-600 focus:border-emerald-500 outline-none placeholder-slate-600"
                    placeholder="ã“ã®ç§‘ç›®ã«ã¤ã„ã¦ã®æŒ¯ã‚Šè¿”ã‚Šã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
                <div class="text-right mt-1">
                    <button onclick="saveCategoryReview()"
                        class="text-xs bg-emerald-900 text-emerald-400 px-3 py-1 rounded border border-emerald-700 hover:bg-emerald-800">Save
                        Review</button>
                </div>
            </div>

            <div class="p-5 border-t border-slate-700 bg-slate-900 rounded-b-xl flex justify-between">
                <button onclick="addModalItem()" id="btnAddItem"
                    class="text-emerald-400 font-bold flex items-center px-4 py-2 rounded border border-emerald-900/50 hover:bg-emerald-900/20">+
                    æ˜ç´°è¿½åŠ </button>
                <div class="flex space-x-3"><button onclick="closeModal()"
                        class="px-5 py-2 text-slate-400 hover:text-white transition">é–‰ã˜ã‚‹</button><button
                        onclick="saveModalData()"
                        class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold shadow-lg">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal 2: New Category -->
    <div id="categoryModal"
        class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-md rounded-xl shadow-2xl border-2 border-slate-600 p-6">
            <h3 class="text-xl font-bold text-white mb-4">æ–°è¦ç§‘ç›®ã®ä½œæˆ</h3>
            <div class="mb-4"><label class="block text-slate-400 text-xs uppercase mb-2">ç§‘ç›®å</label><input type="text"
                    id="newCategoryName"
                    class="w-full bg-slate-900 border border-slate-600 text-white px-4 py-2 rounded focus:border-emerald-500 outline-none">
            </div>
            <input type="hidden" id="newCategoryType" value="">
            <div class="flex justify-end space-x-3 mt-6"><button onclick="closeCategoryModal()"
                    class="px-4 py-2 text-slate-400 hover:text-white">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onclick="saveNewCategory()"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">ä½œæˆ</button></div>
        </div>
    </div>

    <!-- Modal 3: API Key Settings -->
    <div id="apiKeyModal"
        class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-md rounded-xl shadow-2xl border-2 border-slate-600 p-6">
            <h3 class="text-xl font-bold text-white mb-2">Gemini API Configuration</h3>
            <p class="text-xs text-slate-400 mb-4">Enter your Google Gemini API Key to enable AI Diagnosis.</p>
            <div class="mb-4">
                <label class="block text-slate-400 text-xs uppercase mb-2">API KEY</label>
                <input type="password" id="geminiApiKeyInput"
                    class="w-full bg-slate-900 border border-slate-600 text-white px-4 py-2 rounded focus:border-emerald-500 outline-none font-mono"
                    placeholder="AIzaSy...">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeApiKeyModal()" class="px-4 py-2 text-slate-400 hover:text-white">Close</button>
                <button onclick="saveApiKey()"
                    class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold">Save Key</button>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg text-white text-xs font-bold transition-opacity duration-500 opacity-0 pointer-events-none z-[100]">
        <span id="toastMsg">Notification</span>
    </div>

    <script>
        // --- Configuration & State ---
        const fiscalMonths = ['2025-10', '2025-11', '2025-12', '2026-01', '2026-02', '2026-03', '2026-04', '2026-05', '2026-06', '2026-07', '2026-08', '2026-09'];
        const monthlyPlans = {
            '2025-10': { l1_r: 532284, l1_e: 532284, l2_r: 30000, l2_e: 1024484, l3_r: 80000, l3_e: 97500 },
            '2025-11': { l1_r: 641854, l1_e: 671854, l2_r: 450000, l2_e: 1148054, l3_r: 200000, l3_e: 61500 },
            '2025-12': { l1_r: 534304, l1_e: 534304, l2_r: 2300000, l2_e: 1037504, l3_r: 200000, l3_e: 97500 },
            '2026-01': { l1_r: 3000000, l1_e: 1200000, l2_r: 1500000, l2_e: 500000, l3_r: 200000, l3_e: 100000 },
            '2026-02': { l1_r: 3200000, l1_e: 1100000, l2_r: 1000000, l2_e: 400000, l3_r: 200000, l3_e: 100000 },
            '2026-03': { l1_r: 2500000, l1_e: 1400000, l2_r: 800000, l2_e: 400000, l3_r: 250000, l3_e: 100000 },
            '2026-04': { l1_r: 1500000, l1_e: 1000000, l2_r: 500000, l2_e: 300000, l3_r: 250000, l3_e: 100000 },
            '2026-05': { l1_r: 800000, l1_e: 800000, l2_r: 300000, l2_e: 200000, l3_r: 300000, l3_e: 100000 },
            '2026-06': { l1_r: 300000, l1_e: 600000, l2_r: 200000, l2_e: 150000, l3_r: 300000, l3_e: 100000 },
            '2026-07': { l1_r: 100000, l1_e: 500000, l2_r: 100000, l2_e: 100000, l3_r: 400000, l3_e: 120000 },
            '2026-08': { l1_r: 100000, l1_e: 500000, l2_r: 100000, l2_e: 100000, l3_r: 400000, l3_e: 120000 },
            '2026-09': { l1_r: 200000, l1_e: 600000, l2_r: 100000, l2_e: 100000, l3_r: 300000, l3_e: 100000 },
        };

        let currentMonthIdx = 0;
        let currentLevel = 'L1';
        let currentView = 'monthly';
        let currentModalTab = 'actual';

        const initialData = {
            L1: {
                name: 'è¾²åœ’äº‹æ¥­ (Farm)', icon: 'ğŸŒ±', colorClass: 'green',
                revenue: [{ id: 'l1_r_main', name: 'è¾²åœ’åå…¥ (CSVè¨ˆç”»åˆ†)', type: 'l1_r', items: [], budgetItems: [] }],
                expense: [{ id: 'l1_e_main', name: 'è¾²åœ’æ”¯å‡º (CSVè¨ˆç”»åˆ†)', type: 'l1_e', items: [], budgetItems: [] }]
            },
            L2: {
                name: 'è²©å£²äº‹æ¥­ (Sales)', icon: 'ğŸ›’', colorClass: 'blue',
                revenue: [{ id: 'l2_r_main', name: 'è²©å£²åå…¥ (CSVè¨ˆç”»åˆ†)', type: 'l2_r', items: [], budgetItems: [] }],
                expense: [{ id: 'l2_e_main', name: 'è²©å£²æ”¯å‡º (CSVè¨ˆç”»åˆ†)', type: 'l2_e', items: [], budgetItems: [] }]
            },
            L3: {
                name: 'ã‚«ãƒ•ã‚§ãƒãƒ¼ (Cafe)', icon: 'â˜•', colorClass: 'orange',
                revenue: [{ id: 'l3_r_main', name: 'ã‚«ãƒ•ã‚§åå…¥ (CSVè¨ˆç”»åˆ†)', type: 'l3_r', items: [], budgetItems: [] }],
                expense: [{ id: 'l3_e_main', name: 'ã‚«ãƒ•ã‚§æ”¯å‡º (CSVè¨ˆç”»åˆ†)', type: 'l3_e', items: [], budgetItems: [] }]
            },
            fixedMonths: {},
            monthlyComments: {}, // Map<MonthStr, CommentString>
            initialCash: 1000000
        };

        window.appState = JSON.parse(JSON.stringify(initialData));

        let currentEditingId = null;
        let currentEditingType = null;
        let currentModalIsFixed = false;
        let trendChart = null;
        let sectorChart = null;
        let cashFlowChart = null;

        function init() {
            renderMonthlyView();
            updateGlobalHeader();
        }

        window.addEventListener('state-updated', () => {
            if (document.getElementById('initialCashInput')) {
                // FIXED: Handle 0 properly so it doesn't show blank or default
                const val = (window.appState.initialCash !== undefined) ? window.appState.initialCash : 1000000;
                document.getElementById('initialCashInput').value = val;
            }
            renderMonthlyView();
            updateGlobalHeader();
            if (currentView === 'annual') renderAnnualView();
        });

        window.addEventListener('app-ready', () => { init(); });

        function updateSectorName(el) {
            const newName = el.innerText.trim();
            if (newName) {
                window.appState[currentLevel].name = newName;
                if (window.saveToCloud) window.saveToCloud();
            }
        }
        window.updateSectorName = updateSectorName;

        function updateCategoryName(el, id, type) {
            const newName = el.innerText.trim();
            if (newName) {
                const category = window.appState[currentLevel][type].find(c => c.id === id);
                if (category) {
                    category.name = newName;
                    if (window.saveToCloud) window.saveToCloud();
                }
            }
        }
        window.updateCategoryName = updateCategoryName;

        function updateInitialCash(val) {
            // FIXED: Allow 0
            if (val === '') return;
            window.appState.initialCash = parseInt(val);
            if (isNaN(window.appState.initialCash)) window.appState.initialCash = 0;

            if (window.saveToCloud) window.saveToCloud();
            renderAnnualView();
        }
        window.updateInitialCash = updateInitialCash;

        // --- View Logic ---
        function switchView(view) {
            currentView = view;
            const mContainer = document.getElementById('view-monthly');
            const aContainer = document.getElementById('view-annual');
            const mTab = document.getElementById('tab-monthly');
            const aTab = document.getElementById('tab-annual');
            const monthSelector = document.getElementById('monthSelectorContainer');

            if (view === 'annual') {
                mContainer.style.transform = 'translateX(-100%)';
                aContainer.style.transform = 'translateX(0)';
                monthSelector.style.display = 'none';
                mTab.className = "tab-inactive px-4 py-1.5 text-sm font-bold rounded transition flex items-center";
                aTab.className = "tab-active px-4 py-1.5 text-sm font-bold rounded transition flex items-center";
                renderAnnualView();
            } else {
                mContainer.style.transform = 'translateX(0)';
                aContainer.style.transform = 'translateX(100%)';
                monthSelector.style.display = 'flex';
                mTab.className = "tab-active px-4 py-1.5 text-sm font-bold rounded transition flex items-center";
                aTab.className = "tab-inactive px-4 py-1.5 text-sm font-bold rounded transition flex items-center";
            }
        }
        window.switchView = switchView;

        function switchLevel(level) {
            currentLevel = level;
            renderMonthlyView();
        }
        window.switchLevel = switchLevel;

        function changeMonth(delta) {
            let newIdx = currentMonthIdx + delta;
            if (newIdx < 0) newIdx = 0;
            if (newIdx >= fiscalMonths.length) newIdx = fiscalMonths.length - 1;
            currentMonthIdx = newIdx;
            document.getElementById('currentMonthDisplay').textContent = fiscalMonths[currentMonthIdx];
            if (currentView === 'monthly') renderMonthlyView();
        }
        window.changeMonth = changeMonth;

        function getMonthlyBudgetFromCSV(monthStr, planKey) {
            if (monthlyPlans[monthStr] && monthlyPlans[monthStr][planKey] !== undefined) {
                return monthlyPlans[monthStr][planKey];
            }
            return 0;
        }

        function getComputedBudget(category, monthStr) {
            if (!category.budgetItems) category.budgetItems = [];
            const monthBudgetItems = category.budgetItems.filter(i => i.date.startsWith(monthStr));
            if (monthBudgetItems.length > 0) {
                return monthBudgetItems.reduce((sum, i) => sum + i.val, 0);
            }
            return getMonthlyBudgetFromCSV(monthStr, category.type);
        }

        // --- Fix & Result Logic ---
        function toggleFixMonth() {
            const currentMonthStr = fiscalMonths[currentMonthIdx];
            if (!window.appState.fixedMonths) window.appState.fixedMonths = {};
            const isCurrentlyFixed = window.appState.fixedMonths[currentMonthStr];
            window.appState.fixedMonths[currentMonthStr] = !isCurrentlyFixed;
            if (window.saveToCloud) window.saveToCloud();
            renderMonthlyView();
            if (!isCurrentlyFixed) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }
        window.toggleFixMonth = toggleFixMonth;

        async function analyzeWithGemini(monthStr, force = false) {
            const apiKey = localStorage.getItem('nakamura_gemini_key');

            // UI Setup
            document.getElementById('aiAnalysisSection').classList.remove('hidden');
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiComment').innerText = '';
            const btnRefresh = document.getElementById('btnAiRefresh');
            if (btnRefresh) btnRefresh.classList.add('hidden');

            // If already has comment, show it (don't re-generate to save cost/time)
            if (!force && window.appState.monthlyComments && window.appState.monthlyComments[monthStr]) {
                document.getElementById('aiLoading').classList.add('hidden');
                typewriterEffect(window.appState.monthlyComments[monthStr]);
                if (btnRefresh) btnRefresh.classList.remove('hidden');
                return;
            }

            if (!apiKey) {
                document.getElementById('aiLoading').classList.add('hidden');
                document.getElementById('aiComment').innerHTML = '<span class="text-orange-400">API Key not valid. Set key to enable AI diagnosis.</span>';
                return;
            }

            // Gather Data
            let totalRev = 0, totalExp = 0, totalRevPlan = 0;
            const sectorDetails = [];
            let userReviews = [];

            ['L1', 'L2', 'L3'].forEach(lvl => {
                const d = window.appState[lvl];
                let sRev = 0, sExp = 0;

                const scanItems = (cats) => {
                    let sum = 0;
                    cats.forEach(c => {
                        const mItems = (c.items || []).filter(i => i.date.startsWith(monthStr));
                        sum += mItems.reduce((s, i) => s + i.val, 0);

                        // Collect Category Reviews
                        if (c.reviews && c.reviews[monthStr]) {
                            userReviews.push(`- Category "${c.name}": ${c.reviews[monthStr]}`);
                        }
                    });
                    return sum;
                };

                sRev = scanItems(d.revenue);
                sExp = scanItems(d.expense);

                totalRev += sRev;
                totalExp += sExp;

                // Get Plan
                let sRevPlan = 0;
                d.revenue.forEach(c => sRevPlan += getComputedBudget(c, monthStr));
                totalRevPlan += sRevPlan;

                sectorDetails.push(`${d.name}: Rev ${sRev}, Exp ${sExp} (Target Rev: ${sRevPlan})`);
            });

            const profit = totalRev - totalExp;

            let reviewContext = "";
            if (userReviews.length > 0) {
                reviewContext = `
                [User's Self-Reflections for specific items]
                ${userReviews.join('\n')}
                
                Please take these reflections into account. If the user mentions bad conditions, be sympathetic. If they mention waste, be strict.
                Include specific advice based on these reviews.
                `;
            }

            const prompt = `
            ã‚ãªãŸã¯è¿‘æœªæ¥ã®è¾²æ¥­çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ ã®æˆ¦ç•¥AIå‚è¬€ã§ã™ã€‚
            æŒ‡æ®å®˜ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã«å¯¾ã—ã¦ã€ä»Šæœˆã®åæ”¯çµæœã«åŸºã¥ãç°¡å˜ãªå ±å‘Šã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã ã•ã„ã€‚

            Data for ${monthStr}:
            Total Revenue: ${totalRev}
            Total Expense: ${totalExp}
            Profit: ${profit}
            Target Revenue: ${totalRevPlan}

            Sectors:
            ${sectorDetails.join('\n')}
            
            ${reviewContext}

            Tone: Sci-Fi, Professional, slightly encouraging but strict on numbers.
            Length: Around 150-250 Japanese characters.
            Output only the message.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const comment = data.candidates[0].content.parts[0].text;

                // Save
                if (!window.appState.monthlyComments) window.appState.monthlyComments = {};
                window.appState.monthlyComments[monthStr] = comment;
                if (window.saveToCloud) window.saveToCloud();

                // Show
                document.getElementById('aiLoading').classList.add('hidden');
                if (btnRefresh) btnRefresh.classList.remove('hidden');
                typewriterEffect(comment);

            } catch (e) {
                console.error(e);
                document.getElementById('aiLoading').classList.add('hidden');
                let errMsg = "COMMUNICATION ERROR: " + e.message;
                // Check for 503 or overload related errors
                if (e.message.includes('503') || e.message.toLowerCase().includes('overloaded')) {
                    errMsg = "âš ï¸ ACCESS BUSY: AIå‚è¬€ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ç½®ã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
                }
                document.getElementById('aiComment').innerHTML = `<span class="text-xs text-orange-400 font-mono">${errMsg}</span>`;
            }
        }

        function forceReAnalyze() {
            const currentMonthStr = fiscalMonths[currentMonthIdx];
            analyzeWithGemini(currentMonthStr, true);
        }
        window.forceReAnalyze = forceReAnalyze;

        function typewriterEffect(text) {
            const el = document.getElementById('aiComment');
            el.innerText = "";
            let i = 0;
            const speed = 20;
            function type() {
                if (i < text.length) {
                    el.innerText += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        function renderMonthlyView() {
            const data = window.appState[currentLevel];
            const currentMonthStr = fiscalMonths[currentMonthIdx];
            const isFixed = window.appState.fixedMonths && window.appState.fixedMonths[currentMonthStr];

            const btnToggle = document.getElementById('btnToggleFix');
            const statusBadge = document.getElementById('fixStatusBadge');
            const lockedOverlay = document.getElementById('lockedOverlay');
            const resultBoard = document.getElementById('resultBoard');
            const aiSection = document.getElementById('aiAnalysisSection');

            if (isFixed) {
                btnToggle.innerText = "ğŸ”“ UNLOCK";
                btnToggle.className = "px-6 py-2 rounded bg-slate-600 hover:bg-slate-500 text-white font-bold font-sci-fi transition shadow-lg";
                statusBadge.innerText = "FIXED (READ ONLY)";
                statusBadge.className = "px-3 py-1 rounded text-xs font-black tracking-widest bg-emerald-700 text-white";
                lockedOverlay.classList.add('hidden'); // REMOVED LOCK OVERLAY
                resultBoard.classList.remove('hidden');
                document.getElementById('btnNewRev').style.display = 'none';
                document.getElementById('btnNewExp').style.display = 'none';
                calculateAndShowResults(currentMonthStr);

                // Trigger AI Analysis
                analyzeWithGemini(currentMonthStr);

            } else {
                btnToggle.innerText = "ğŸ”’ FIX MONTH";
                btnToggle.className = "px-6 py-2 rounded bg-blue-600 hover:bg-blue-500 text-white font-bold font-sci-fi transition shadow-lg";
                statusBadge.innerText = "EDITING";
                statusBadge.className = "px-3 py-1 rounded text-xs font-black tracking-widest bg-slate-700 text-slate-400";
                lockedOverlay.classList.add('hidden');
                resultBoard.classList.add('hidden');
                if (aiSection) aiSection.classList.add('hidden');
                document.getElementById('btnNewRev').style.display = 'block';
                document.getElementById('btnNewExp').style.display = 'block';
            }

            ['L1', 'L2', 'L3'].forEach(l => {
                const btn = document.getElementById(`nav-${l}`);
                const isActive = l === currentLevel;
                const color = window.appState[l].colorClass;
                btn.className = isActive
                    ? `w-16 h-16 rounded-xl bg-slate-600 text-white flex flex-col items-center justify-center border-2 border-${color}-500 shadow-lg scale-110 transition`
                    : `group w-16 h-16 rounded-xl bg-slate-800 text-slate-500 flex flex-col items-center justify-center border-2 border-transparent hover:bg-slate-700 transition`;
            });

            const sectorTitleEl = document.getElementById('sectorTitle');
            const colorClass = window.appState[currentLevel].colorClass;
            let colorTailwind = "text-emerald-400";
            if (colorClass === 'blue') colorTailwind = "text-blue-400";
            if (colorClass === 'orange') colorTailwind = "text-orange-400";
            sectorTitleEl.innerText = `SECTOR ${currentLevel}`;
            sectorTitleEl.className = `font-sci-fi block text-xs tracking-widest ${colorTailwind}`;

            const sectorNameEl = document.getElementById('sectorName');
            if (sectorNameEl.innerText !== data.name) sectorNameEl.innerText = data.name;
            sectorNameEl.contentEditable = !isFixed;

            document.getElementById('sectorIcon').textContent = data.icon;
            document.querySelectorAll('.current-month-text').forEach(el => el.textContent = currentMonthStr);

            const revContainer = document.getElementById('revenueContainer');
            const expContainer = document.getElementById('expenseContainer');
            revContainer.innerHTML = '';
            expContainer.innerHTML = '';

            let totalRevPlan = 0;
            let totalExpPlan = 0;

            const getMonthTotal = (items) => {
                if (!items) return 0;
                return items.filter(i => i.date.startsWith(currentMonthStr)).reduce((sum, i) => sum + i.val, 0);
            };

            data.revenue.forEach(cat => {
                const actual = getMonthTotal(cat.items);
                const budget = getComputedBudget(cat, currentMonthStr);
                totalRevPlan += budget;
                revContainer.appendChild(createCard(cat, 'revenue', actual, budget, isFixed));
            });

            data.expense.forEach(cat => {
                const actual = getMonthTotal(cat.items);
                const budget = getComputedBudget(cat, currentMonthStr);
                totalExpPlan += budget;
                expContainer.appendChild(createCard(cat, 'expense', actual, budget, isFixed));
            });

            document.getElementById('sectorRevPlan').textContent = 'Â¥' + totalRevPlan.toLocaleString();
            document.getElementById('sectorExpPlan').textContent = 'Â¥' + totalExpPlan.toLocaleString();
        }

        function calculateAndShowResults(monthStr) {
            let totalRevAct = 0, totalRevPlan = 0;
            let totalExpAct = 0, totalExpPlan = 0;

            ['L1', 'L2', 'L3'].forEach(lvl => {
                const d = window.appState[lvl];
                d.revenue.forEach(c => {
                    totalRevAct += (c.items || []).filter(i => i.date.startsWith(monthStr)).reduce((s, i) => s + i.val, 0);
                    totalRevPlan += getComputedBudget(c, monthStr);
                });
                d.expense.forEach(c => {
                    totalExpAct += (c.items || []).filter(i => i.date.startsWith(monthStr)).reduce((s, i) => s + i.val, 0);
                    totalExpPlan += getComputedBudget(c, monthStr);
                });
            });

            const profitAct = totalRevAct - totalExpAct;
            const profitPlan = totalRevPlan - totalExpPlan;

            document.getElementById('resRevAct').innerText = 'Â¥' + totalRevAct.toLocaleString();
            document.getElementById('resRevPlan').innerText = 'Â¥' + totalRevPlan.toLocaleString();

            const badgeRev = document.getElementById('badgeRev');
            const barRev = document.getElementById('barRev');
            if (totalRevAct >= totalRevPlan) {
                badgeRev.innerText = "WIN"; badgeRev.className = "absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-win";
                barRev.className = "bg-emerald-500 h-full transition-all";
            } else {
                badgeRev.innerText = "LOSE"; badgeRev.className = "absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-lose";
                barRev.className = "bg-red-500 h-full transition-all";
            }
            barRev.style.width = Math.min(100, (totalRevAct / Math.max(1, totalRevPlan)) * 100) + '%';

            document.getElementById('resExpAct').innerText = 'Â¥' + totalExpAct.toLocaleString();
            document.getElementById('resExpPlan').innerText = 'Â¥' + totalExpPlan.toLocaleString();

            const badgeExp = document.getElementById('badgeExp');
            const barExp = document.getElementById('barExp');
            if (totalExpAct <= totalExpPlan) {
                badgeExp.innerText = "WIN"; badgeExp.className = "absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-win";
                barExp.className = "bg-emerald-500 h-full transition-all";
            } else {
                badgeExp.innerText = "LOSE"; badgeExp.className = "absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-lose";
                barExp.className = "bg-red-500 h-full transition-all";
            }
            barExp.style.width = Math.min(100, (totalExpAct / Math.max(1, totalExpPlan)) * 100) + '%';

            document.getElementById('resProfit').innerText = 'Â¥' + profitAct.toLocaleString();
            document.getElementById('resProfitPlan').innerText = 'Â¥' + profitPlan.toLocaleString();
            const badgeProfit = document.getElementById('badgeProfit');
            if (profitAct >= profitPlan) {
                badgeProfit.innerText = "WIN"; badgeProfit.className = "absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-win";
            } else {
                badgeProfit.innerText = "LOSE"; badgeProfit.className = "absolute top-4 right-4 px-3 py-1 rounded text-xs font-black transform rotate-12 shadow-lg badge-lose";
            }
        }

        function createCard(category, type, actualValue, budgetValue, isFixed) {
            const isRev = type === 'revenue';
            const progress = budgetValue > 0 ? (actualValue / budgetValue) * 100 : 0;
            let barColor = isRev ? 'bg-emerald-500' : 'bg-blue-500';
            if (isRev && progress >= 100) barColor = 'bg-yellow-400';
            if (!isRev && progress > 100) barColor = 'bg-red-500';

            const div = document.createElement('div');
            div.className = "bg-slate-800 border border-slate-700 rounded-xl p-4 cursor-pointer card-hover relative overflow-hidden group";

            div.onclick = (e) => {
                if (e.target.isContentEditable) return;
                openModal(category.id, type);
            };

            const editHint = isFixed ? '<div class="absolute right-2 bottom-2 text-slate-500 text-xs font-bold pointer-events-none">LOCKED</div>' : '<div class="absolute right-2 bottom-2 opacity-0 group-hover:opacity-100 transition text-emerald-400 text-xs font-bold pointer-events-none">EDIT ></div>';
            const editableAttr = isFixed ? '' : 'contenteditable="true"';

            div.innerHTML = `
                <div class="flex justify-between items-start mb-2 relative z-10">
                    <h4 ${editableAttr} onblur="updateCategoryName(this, '${category.id}', '${type}')" class="font-bold text-white hover:border-b hover:border-emerald-500 transition">${category.name}</h4>
                    <div class="text-right">
                        <div class="text-white font-mono font-bold text-lg">Â¥${actualValue.toLocaleString()}</div>
                    </div>
                </div>
                <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden relative z-10 mb-1">
                    <div class="${barColor} h-full transition-all" style="width: ${Math.min(100, progress)}%"></div>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500 relative z-10">
                    <span>Plan: Â¥${budgetValue.toLocaleString()}</span>
                    <span>${progress.toFixed(0)}%</span>
                </div>
                ${editHint}
            `;
            return div;
        }

        function renderAnnualView() {
            let currentBalance = (window.appState.initialCash !== undefined) ? window.appState.initialCash : 1000000;
            const balanceHistory = [];
            const labels = [];

            const monthlyStats = fiscalMonths.map(month => {
                let stats = { month, farmRev: 0, salesRev: 0, cafeRev: 0, totalRev: 0, totalExp: 0, totalRevPlan: 0 };

                // HYBRID LOGIC FOR CHART CALCULATION
                // ----------------------------------------------------
                const isFixed = window.appState.fixedMonths && window.appState.fixedMonths[month];
                let monthRevForFlow = 0;
                let monthExpForFlow = 0;

                ['L1', 'L2', 'L3'].forEach(lvl => {
                    const d = window.appState[lvl];

                    // 1. Calculate Actuals (Used if Fixed)
                    const revAct = d.revenue.reduce((acc, c) => acc + (c.items || []).filter(i => i.date.startsWith(month)).reduce((s, i) => s + i.val, 0), 0);
                    const expAct = d.expense.reduce((acc, c) => acc + (c.items || []).filter(i => i.date.startsWith(month)).reduce((s, i) => s + i.val, 0), 0);

                    // 2. Calculate Plans (Used if Not Fixed)
                    const revPlan = d.revenue.reduce((acc, c) => acc + getComputedBudget(c, month), 0);
                    const expPlan = d.expense.reduce((acc, c) => acc + getComputedBudget(c, month), 0);

                    // 3. Stats for Table/Chart (Always show Actual vs Plan separately in table)
                    if (lvl === 'L1') stats.farmRev = revAct;
                    if (lvl === 'L2') stats.salesRev = revAct;
                    if (lvl === 'L3') stats.cafeRev = revAct;
                    stats.totalRev += revAct;
                    stats.totalExp += expAct;
                    stats.totalRevPlan += revPlan; // For trend chart comparison

                    // 4. Flow Calculation
                    if (isFixed) {
                        monthRevForFlow += revAct;
                        monthExpForFlow += expAct;
                    } else {
                        monthRevForFlow += revPlan;
                        monthExpForFlow += expPlan;
                    }
                });

                const netMove = monthRevForFlow - monthExpForFlow;
                currentBalance += netMove;
                balanceHistory.push(currentBalance);
                labels.push(month);

                return stats;
            });

            updateCashFlowChart(labels, balanceHistory);
            updateAnnualCharts(monthlyStats);

            // ... Table Update Code ...
            const tbody = document.getElementById('annualTableBody');
            tbody.innerHTML = '';
            monthlyStats.forEach(m => {
                const p = m.totalRev - m.totalExp;
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="px-6 py-3 font-medium text-slate-900">${m.month}</td>
                    <td class="px-6 py-3 text-right">${m.farmRev > 0 ? m.farmRev.toLocaleString() : '-'}</td>
                    <td class="px-6 py-3 text-right">${m.salesRev > 0 ? m.salesRev.toLocaleString() : '-'}</td>
                    <td class="px-6 py-3 text-right">${m.cafeRev > 0 ? m.cafeRev.toLocaleString() : '-'}</td>
                    <td class="px-6 py-3 text-right font-bold border-l bg-green-50">${m.totalRev.toLocaleString()}</td>
                    <td class="px-6 py-3 text-right font-bold border-l bg-red-50 text-red-600">${m.totalExp.toLocaleString()}</td>
                    <td class="px-6 py-3 text-right font-black border-l ${p >= 0 ? 'text-green-600' : 'text-red-600'}">${p.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateCashFlowChart(labels, data) {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            if (cashFlowChart) cashFlowChart.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(34, 197, 94, 0.2)');
            gradient.addColorStop(1, 'rgba(239, 68, 68, 0.5)');

            cashFlowChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cash Balance (è³‡é‡‘æ®‹é«˜)',
                        data: data,
                        borderColor: '#0f172a',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: data.map(v => v < 0 ? '#dc2626' : '#10b981'),
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    label: { content: 'Shortage Limit', enabled: true, position: 'end' }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: (ctx) => ctx.tick.value === 0 ? '#ef4444' : '#e2e8f0', lineWidth: (ctx) => ctx.tick.value === 0 ? 2 : 1 },
                            ticks: { callback: v => 'Â¥' + v.toLocaleString() }
                        }
                    }
                }
            });
        }

        // ... Keep existing updateAnnualCharts ...
        function updateAnnualCharts(data) {
            const ctxTrend = document.getElementById('annualTrendChart').getContext('2d');
            const ctxSector = document.getElementById('annualSectorChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            if (sectorChart) sectorChart.destroy();

            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [
                        { label: 'å®Ÿç¸¾ (Actual)', data: data.map(d => d.totalRev), borderColor: '#10b981', tension: 0.3 },
                        { label: 'æ”¯å‡º (Expense)', data: data.map(d => d.totalExp), borderColor: '#ef4444', tension: 0.3 },
                        { label: 'åˆ©ç›Š (Profit)', data: data.map(d => d.totalRev - d.totalExp), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            sectorChart = new Chart(ctxSector, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [
                        { label: 'è¾²åœ’', data: data.map(d => d.farmRev), backgroundColor: '#10b981' },
                        { label: 'è²©å£²', data: data.map(d => d.salesRev), backgroundColor: '#3b82f6' },
                        { label: 'ã‚«ãƒ•ã‚§', data: data.map(d => d.cafeRev), backgroundColor: '#f97316' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        }

        // --- Modals (Same as V18) ---
        // (Function definitions are identical to V18)
        function openModal(id, type) {
            currentEditingId = id;
            currentEditingType = type;
            currentModalTab = 'actual';

            const category = window.appState[currentLevel][type].find(c => c.id === id);
            const currentMonthStr = fiscalMonths[currentMonthIdx];
            currentModalIsFixed = window.appState.fixedMonths && window.appState.fixedMonths[currentMonthStr];

            document.getElementById('modalTitle').textContent = category.name + (currentModalIsFixed ? " (LOCKED)" : "");
            document.getElementById('modalMonthDisp').textContent = currentMonthStr;

            updateModalUI();
            document.getElementById('detailModal').classList.remove('hidden');
        }
        window.openModal = openModal;

        function switchModalTab(tab) {
            currentModalTab = tab;
            updateModalUI();
        }
        window.switchModalTab = switchModalTab;

        function updateModalUI() {
            const btnActual = document.getElementById('modalTabActual');
            const btnBudget = document.getElementById('modalTabBudget');
            const btnAdd = document.getElementById('btnAddItem');

            if (currentModalTab === 'actual') {
                btnActual.className = "flex-1 py-3 text-sm font-bold transition modal-tab-active";
                btnBudget.className = "flex-1 py-3 text-sm font-bold transition modal-tab-inactive";
                btnAdd.className = "text-emerald-400 font-bold flex items-center px-4 py-2 rounded border border-emerald-900/50 hover:bg-emerald-900/20";
                btnAdd.innerText = "+ å®Ÿç¸¾è¿½åŠ ";
            } else {
                btnActual.className = "flex-1 py-3 text-sm font-bold transition modal-tab-inactive";
                btnBudget.className = "flex-1 py-3 text-sm font-bold transition modal-tab-active";
                btnAdd.className = "text-blue-400 font-bold flex items-center px-4 py-2 rounded border border-blue-900/50 hover:bg-blue-900/20";
                btnAdd.innerText = "+ äºˆç®—è¿½åŠ ";
            }

            if (currentModalIsFixed) {
                btnAdd.style.display = 'none';
                document.querySelector('button[onclick="saveModalData()"]').style.display = 'none';
                // Show Review Section
                document.getElementById('modalReviewSection').classList.remove('hidden');

                const category = window.appState[currentLevel][currentEditingType].find(c => c.id === currentEditingId);
                const currentMonthStr = fiscalMonths[currentMonthIdx];
                const reviewText = (category.reviews && category.reviews[currentMonthStr]) ? category.reviews[currentMonthStr] : "";
                document.getElementById('modalCategoryReview').value = reviewText;

            } else {
                btnAdd.style.display = 'flex'; // Restore flex
                document.querySelector('button[onclick="saveModalData()"]').style.display = 'block';
                document.getElementById('modalReviewSection').classList.add('hidden');
            }

            renderModalItems();
        }

        function saveCategoryReview() {
            const category = window.appState[currentLevel][currentEditingType].find(c => c.id === currentEditingId);
            const currentMonthStr = fiscalMonths[currentMonthIdx];
            const val = document.getElementById('modalCategoryReview').value;

            if (!category.reviews) category.reviews = {};
            category.reviews[currentMonthStr] = val;

            if (window.saveToCloud) window.saveToCloud();

            // Visual Feedback
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "Saved!";
            setTimeout(() => btn.innerText = originalText, 1000);
        }

        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }
        window.closeModal = closeModal;

        function renderModalItems() {
            const list = document.getElementById('modalItemsList');
            list.innerHTML = '';

            const category = window.appState[currentLevel][currentEditingType].find(c => c.id === currentEditingId);
            const currentMonthStr = fiscalMonths[currentMonthIdx];

            let items = [];
            if (currentModalTab === 'actual') {
                items = category.items || [];
            } else {
                items = category.budgetItems || [];
                const monthItems = items.filter(i => i.date.startsWith(currentMonthStr));
                if (monthItems.length === 0) {
                    const csvVal = getMonthlyBudgetFromCSV(currentMonthStr, category.type);
                    if (csvVal > 0 && !currentModalIsFixed) {
                        const row = document.createElement('div');
                        row.className = "flex justify-between items-center bg-slate-800/50 p-3 rounded border border-slate-700 border-dashed mb-2";
                        row.innerHTML = `
                            <span class="text-slate-500 text-xs italic">CSVåˆæœŸè¨ˆç”»</span>
                            <span class="text-slate-400 font-mono">Â¥${csvVal.toLocaleString()}</span>
                            <button onclick="convertCsvToBudget(${csvVal})" class="text-xs bg-blue-600 text-white px-2 py-1 rounded">å€‹åˆ¥ç·¨é›†</button>
                        `;
                        list.appendChild(row);
                    }
                }
            }

            const relevantIndices = items.map((item, idx) => ({ ...item, idx })).filter(item => item.date.startsWith(currentMonthStr));

            if (relevantIndices.length === 0 && list.children.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-500 py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
            }

            relevantIndices.forEach(itemObj => {
                const row = document.createElement('div');
                row.className = "flex space-x-2 items-center bg-slate-800 p-2 rounded border border-slate-700";

                const valColor = currentModalTab === 'actual' ? 'text-emerald-400' : 'text-blue-400';

                const disabledAttr = currentModalIsFixed ? 'disabled' : '';
                let actionBtn = '';
                if (currentModalIsFixed) {
                    // No item-level review button anymore
                } else {
                    actionBtn = `<button onclick="deleteItem(${itemObj.idx})" class="text-slate-500 hover:text-red-500 px-2">Ã—</button>`;
                }

                row.innerHTML = `
                    <input type="date" value="${itemObj.date}" onchange="updateItem(${itemObj.idx}, 'date', this.value)" class="bg-slate-900 text-white text-xs px-2 py-1 rounded border border-slate-600 cursor-pointer" ${disabledAttr}>
                    <input type="text" value="${itemObj.name}" onchange="updateItem(${itemObj.idx}, 'name', this.value)" class="flex-1 bg-transparent text-white text-sm outline-none px-2" placeholder="Desc" ${disabledAttr}>
                    <input type="number" value="${itemObj.val}" onchange="updateItem(${itemObj.idx}, 'val', this.value)" class="w-24 bg-transparent text-right ${valColor} font-mono font-bold outline-none" placeholder="0" ${disabledAttr}>
                    ${actionBtn}
                `;
                list.appendChild(row);
            });

            // Update Total Header
            const total = relevantIndices.reduce((s, i) => s + i.val, 0);
            let displayTotal = total;
            if (currentModalTab === 'budget' && relevantIndices.length === 0) {
                displayTotal = getMonthlyBudgetFromCSV(currentMonthStr, category.type);
            }

            document.getElementById('modalTotal').textContent = 'Â¥' + displayTotal.toLocaleString();
            document.getElementById('modalTotal').className = currentModalTab === 'actual' ? "text-3xl font-mono font-bold text-emerald-400" : "text-3xl font-mono font-bold text-blue-400";
        }

        // function reviewItem(idx) removed


        function convertCsvToBudget(val) {
            const category = window.appState[currentLevel][currentEditingType].find(c => c.id === currentEditingId);
            if (!category.budgetItems) category.budgetItems = [];
            const defaultDate = fiscalMonths[currentMonthIdx] + '-01';
            category.budgetItems.push({ name: 'åˆæœŸè¨ˆç”» (CSV)', val: val, date: defaultDate });
            if (window.saveToCloud) window.saveToCloud();
            renderModalItems();
        }
        window.convertCsvToBudget = convertCsvToBudget;

        function addModalItem() {
            const category = window.appState[currentLevel][currentEditingType].find(c => c.id === currentEditingId);
            const defaultDate = fiscalMonths[currentMonthIdx] + '-01';

            if (currentModalTab === 'actual') {
                if (!category.items) category.items = [];
                category.items.push({ name: '', val: 0, date: defaultDate });
            } else {
                if (!category.budgetItems) category.budgetItems = [];
                category.budgetItems.push({ name: '', val: 0, date: defaultDate });
            }

            if (window.saveToCloud) window.saveToCloud();
            renderModalItems();
        }
        window.addModalItem = addModalItem;

        function updateItem(realIndex, field, value) {
            const category = window.appState[currentLevel][currentEditingType].find(c => c.id === currentEditingId);
            const targetArray = currentModalTab === 'actual' ? category.items : category.budgetItems;

            if (field === 'val') value = parseInt(value) || 0;
            targetArray[realIndex][field] = value;

            if (window.saveToCloud) window.saveToCloud();
            renderModalItems(); // Re-calc total
        }
        window.updateItem = updateItem;

        function deleteItem(realIndex) {
            const category = window.appState[currentLevel][currentEditingType].find(c => c.id === currentEditingId);
            const targetArray = currentModalTab === 'actual' ? category.items : category.budgetItems;
            targetArray.splice(realIndex, 1);
            if (window.saveToCloud) window.saveToCloud();
            renderModalItems();
        }
        window.deleteItem = deleteItem;

        function saveModalData() {
            if (window.saveToCloud) window.saveToCloud();
            closeModal();
            renderMonthlyView();
            updateGlobalHeader();
        }
        window.saveModalData = saveModalData;

        function updateGlobalHeader() {
            let totalRevPlan = 0;
            let totalExpPlan = 0;
            ['L1', 'L2', 'L3'].forEach(lvl => {
                const d = window.appState[lvl];
                d.revenue.forEach(c => { fiscalMonths.forEach(m => totalRevPlan += getComputedBudget(c, m)); });
                d.expense.forEach(c => { fiscalMonths.forEach(m => totalExpPlan += getComputedBudget(c, m)); });
            });
            const projProfit = totalRevPlan - totalExpPlan;
            const el = document.getElementById('globalProfit');
            el.textContent = 'Â¥' + projProfit.toLocaleString();
            el.className = projProfit >= 0 ? "font-sci-fi font-bold text-2xl text-yellow-400" : "font-sci-fi font-bold text-2xl text-red-500";
        }

        // --- Categories ---
        function openCategoryModal(type) {
            document.getElementById('newCategoryType').value = type;
            document.getElementById('newCategoryName').value = '';
            document.getElementById('categoryModal').classList.remove('hidden');
        }
        window.openCategoryModal = openCategoryModal;

        function closeCategoryModal() { document.getElementById('categoryModal').classList.add('hidden'); }
        window.closeCategoryModal = closeCategoryModal;

        function saveNewCategory() {
            const type = document.getElementById('newCategoryType').value;
            const name = document.getElementById('newCategoryName').value;
            if (name) {
                const newId = Date.now();
                window.appState[currentLevel][type].push({ id: newId, name: name, type: `custom_${newId}`, items: [], budgetItems: [] });
                if (window.saveToCloud) window.saveToCloud();
                renderMonthlyView();
                closeCategoryModal();
            }
        }
        window.saveNewCategory = saveNewCategory;

        // --- API Key Modal ---
        function openApiKeyModal() {
            const key = localStorage.getItem('nakamura_gemini_key') || '';
            document.getElementById('geminiApiKeyInput').value = key;
            document.getElementById('apiKeyModal').classList.remove('hidden');
        }
        window.openApiKeyModal = openApiKeyModal;

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('hidden');
        }
        window.closeApiKeyModal = closeApiKeyModal;

        function saveApiKey() {
            const key = document.getElementById('geminiApiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('nakamura_gemini_key', key);
                showToast("API Key Saved", "bg-emerald-600");
                closeApiKeyModal();
            }
        }
        window.saveApiKey = saveApiKey;

        // Init
        // Event listeners are mostly inline or added via logic
    </script>
</body>

</html>